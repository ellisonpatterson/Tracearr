name: Mobile Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: mobile-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Check if this is a prerelease (alpha, beta, rc)
  check-release-type:
    name: Check Release Type
    runs-on: ubuntu-latest
    outputs:
      prerelease: ${{ steps.check.outputs.prerelease }}
      previous_tag: ${{ steps.prev_tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if prerelease
        id: check
        run: |
          if [[ "${{ github.ref_name }}" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a prerelease: ${{ github.ref_name }}"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release: ${{ github.ref_name }}"
          fi

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

  # Check if mobile code changed since last tag
  check-mobile-changes:
    name: Check Mobile Changes
    runs-on: ubuntu-latest
    needs: [check-release-type]
    if: needs.check-release-type.outputs.prerelease == 'true'
    outputs:
      mobile_changed: ${{ steps.check.outputs.changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for mobile changes
        id: check
        run: |
          PREV_TAG="${{ needs.check-release-type.outputs.previous_tag }}"

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, assuming mobile changed"
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if any files in apps/mobile changed
          CHANGES=$(git diff --name-only "$PREV_TAG" "${{ github.ref_name }}" -- apps/mobile/ | wc -l)

          if [ "$CHANGES" -gt 0 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Mobile changes detected: $CHANGES files"
            git diff --name-only "$PREV_TAG" "${{ github.ref_name }}" -- apps/mobile/
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No mobile changes since $PREV_TAG"
          fi

  # Build and submit iOS to TestFlight
  build-ios:
    name: Build & Submit iOS
    runs-on: ubuntu-latest
    needs: [check-release-type, check-mobile-changes]
    if: |
      needs.check-release-type.outputs.prerelease == 'true' &&
      needs.check-mobile-changes.outputs.mobile_changed == 'true'
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Sync version from git tag
        run: |
          # Extract version from tag (v1.2.3-alpha.4 -> 1.2.3)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"           # Remove 'v' prefix
          VERSION="${VERSION%%-*}"         # Remove prerelease suffix (-alpha.4, -beta.1, etc.)
          echo "Setting app version to: $VERSION"
          # Update app.json with the version
          jq --arg v "$VERSION" '.expo.version = $v' app.json > tmp.json && mv tmp.json app.json
          cat app.json | jq '.expo.version'

      - name: Build and submit iOS
        run: |
          eas build \
            --platform ios \
            --profile preview \
            --auto-submit \
            --submit-profile preview \
            --non-interactive \
            --no-wait
        env:
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}

  # Build and submit Android to Play Store internal track
  build-android:
    name: Build & Submit Android
    runs-on: ubuntu-latest
    needs: [check-release-type, check-mobile-changes]
    if: |
      needs.check-release-type.outputs.prerelease == 'true' &&
      needs.check-mobile-changes.outputs.mobile_changed == 'true'
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Sync version from git tag
        run: |
          # Extract version from tag (v1.2.3-alpha.4 -> 1.2.3)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"           # Remove 'v' prefix
          VERSION="${VERSION%%-*}"         # Remove prerelease suffix (-alpha.4, -beta.1, etc.)
          echo "Setting app version to: $VERSION"
          # Update app.json with the version
          jq --arg v "$VERSION" '.expo.version = $v' app.json > tmp.json && mv tmp.json app.json
          cat app.json | jq '.expo.version'

      - name: Decode Google Service Account
        run: |
          mkdir -p credentials
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}" | base64 -d > credentials/google-service-account.json

      - name: Build and submit Android
        run: |
          eas build \
            --platform android \
            --profile preview \
            --auto-submit \
            --submit-profile preview \
            --non-interactive \
            --no-wait

  # Summary job that reports status
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [check-release-type, check-mobile-changes, build-ios, build-android]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "## Mobile Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease**: ${{ needs.check-release-type.outputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mobile Changed**: ${{ needs.check-mobile-changes.outputs.mobile_changed || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check-release-type.outputs.prerelease }}" != "true" ]]; then
            echo "ℹ️ Skipped: Not a prerelease (stable releases don't trigger mobile builds)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.check-mobile-changes.outputs.mobile_changed }}" != "true" ]]; then
            echo "ℹ️ Skipped: No mobile code changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Build Status" >> $GITHUB_STEP_SUMMARY
            echo "- iOS: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Android: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Builds submitted to EAS. Check [Expo dashboard](https://expo.dev) for progress." >> $GITHUB_STEP_SUMMARY
          fi
